<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Texturen-Generator - SomaWerk Medienproduktion</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f1721; --muted:#9fb0c4; --accent:#1B0087;
  }
  html,body{height:100%;margin:0;overflow:auto; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue";background:
    linear-gradient(180deg,#07101a 0%, #071827 100%); color:#e6f2fb;}
  .app {
  display: grid;
  grid-template-rows: auto 1fr auto; 
  grid-template-columns: 360px 1fr;
  gap: 18px;
  height: 100vh; 
  padding: 18px;
  box-sizing: border-box;
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03); box-shadow: 0 12px 30px rgba(0,0,0,0.6);}
  header{grid-column:1/-1;display:flex;align-items:center;gap:12px;margin-bottom:6px}
  .logo{display:flex;align-items:center;gap:10px}
  .logo .mark{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#5E5E5E);display:flex;align-items:center;justify-content:center;color:#ffffff;font-weight:800}
  .controls{margin-left:auto;display:flex;gap:8px}
  .btn{background:rgba(255,255,255,0.03);color:var(--muted);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;font-weight:700}
  .btn:active{transform:translateY(1px)}
.left {
  height: 100%;
  overflow: auto;
}
  .row{display:flex;gap:20px;align-items:center}
  label{font-size:13px;color:var(--muted);min-width:110px}
  input[type="range"]{width:100%}
  input[type="color"]{width:44px;height:34px;border-radius:6px;border:0;padding:0}
  select,input[type="number"]{background:rgba(255,255,255,0.02);color:#e7f6ff;border:1px solid rgba(255,255,255,0.02);padding:8px;border-radius:8px}
  /* Dunkle Dropdown-Men√ºs */
select option {
  color: #ffffff;            
  background-color: #0b1622;  
}
  .preview{width:100%;height:100%;display:flex;align-items:center;justify-content:center; height:calc(100%);}.preview {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;      /* volle Breite der Grid-Spalte */
  max-height: calc(100vh - <header_height> - <footer_height> - 36px); 
  box-sizing: border-box;
  grid-column: 2 / 3; /* explizit die zweite Spalte nutzen */
}

  canvas{background:#111;border-radius:10px;box-shadow:0 18px 60px rgba(0,0,0,0.6);max-width:100%;height:auto}
  .small{font-size:16px;color:var(--muted)}
  .presets{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:12px;padding-top:6px; margin-top:30px;}
  @media(max-width:980px){.app{grid-template-columns:1fr;grid-auto-rows:auto}.preview{height:60vh}}

  /* Abstand zwischen den Zeilen innerhalb einer Gruppe */
.panel .row {
  margin-bottom: 20px; /* Abstand zwischen den einzelnen Reihen */
}

/* Abstand √ºber und unter √úberschriften f√ºr Gruppen */
.panel h3 {
  margin-top: 24px;    /* Abstand √ºber √úberschrift */
  margin-bottom: 12px; /* Abstand unter √úberschrift */
}
/* -----------------------------
   Dunkle Scrollleisten f√ºr alle Elemente
------------------------------ */

/* Webkit-Browser (Chrome, Edge, Safari) */
::-webkit-scrollbar {
  width: 12px;              /* Breite der Scrollleiste */
}

::-webkit-scrollbar-track {
  background: #2b2b2b;      /* Hintergrund der Scrollleiste */
  border-radius: 6px;
}

::-webkit-scrollbar-thumb {
  background-color: #555;    /* Farbe des Scrollbalkens */
  border-radius: 6px;
  border: 3px solid #2b2b2b; /* Abstand zum Track */
}

::-webkit-scrollbar-thumb:hover {
  background-color: #888;    /* Farbe beim Hover */
}

/* Firefox */
* {
  scrollbar-color: #555 #2b2b2b; /* Daumen-Farbe + Track-Farbe */
  scrollbar-width: thin;          /* d√ºnne Scrollleisten */
}
/* Standard: Generator sichtbar, Hinweis versteckt */
#app {
  display: grid;
}
.mobile-block {
  display: none;
  text-align: center;
  padding: 40px;
  font-size: 18px;
}

/* Auf kleinen Ger√§ten Generator sperren */
@media (max-width: 1024px) {
  #app {
    display: none;
  }
  .mobile-block { display: block; }
  }
}

</style>
</head>
<body>
	
	<!-- Hinweis f√ºr mobile Ger√§te -->
<div class="mobile-block">
  ‚ö†Ô∏è Der Texturen-Generator ist nur f√ºr Desktop optimiert.<br>
  Bitte am PC oder Laptop √∂ffnen.
</div>
	
  <div class="app">
    <header class="panel" style="display:flex;align-items:center">
      <div class="logo">
        <div class="mark">TG</div>
        <div>
          <div style="font-weight:800">Texturen-Generator - <b>Soma</b>Werk Medienproduktion</div>
          <div class="small">Generator f√ºr nahtlose Texturen</div>
        </div>
      </div>
      <div class="controls">
	 <div class="controls" style="display:flex;align-items:center;gap:8px;">
  <h3 style="margin:0; font-size:14px;">Voreinstellungen:</h3>
        <button id="presetWood" class="btn">Holz</button>
        <button id="presetConcrete" class="btn">Beton</button>
        <button id="presetMarble" class="btn">Marmor</button>
        <button id="presetFabric" class="btn">Textil</button>
		<button id="randBtn" class="btn">üé≤ Zufall</button>
        </div>
	    
    </header>

    <aside class="panel left">
      <h3 class="small" style="margin:0 0 30px 0">Grundtextur</h3>
      <div class="row">
        <label>Textur</label>
        <select id="patternSelect">
          <option value="wood">Holz</option>
          <option value="concrete">Beton</option>
          <option value="marble">Marmor</option>
          <option value="fabric">Textil</option>
          <option value="customNoise">Benutzerdefiniert</option>
        </select>
      </div>

      <div class="row">
        <label>Basis Farbe</label>
        <input id="baseColor" type="color" value="#a77a4f">
      </div>

      <div class="row">
        <label>Akzent Farbe</label>
        <input id="accentColor" type="color" value="#3b2b22">
      </div>

      <div class="row">
        <label>Gr√∂√üe (Detail)</label>
        <input id="scaleRange" type="range" min="0.2" max="8" step="0.1" value="1.0">
      </div>

      <div class="row">
        <label>Textur / Grain</label>
        <input id="grainRange" type="range" min="0" max="1.5" step="0.01" value="0.45">
      </div>

      <div class="row">
        <label>Rauheit</label>
        <input id="roughRange" type="range" min="0" max="2" step="0.01" value="0.9">
      </div>

      <div class="row">
        <label>Glanz</label>
        <input id="glossRange" type="range" min="0" max="1" step="0.01" value="0.18">
      </div>

      <div class="row">
        <label>Kontrast</label>
        <input id="contrastRange" type="range" min="0" max="2" step="0.01" value="1.05">
      </div>

      <div class="row">
        <label>S√§ttigung</label>
        <input id="saturationRange" type="range" min="0" max="2" step="0.01" value="1.05">
      </div>

      <h3 class="small" style="margin-top:30px; margin-bottom:30px">Textur Spezifikationen</h3>

      <div class="row">
        <label id="woodRingsLabel">Holz-Ringe / Maserung</label>
        <input id="woodRings" type="range" min="0" max="6" step="0.1" value="2.4">
      </div>

      <div class="row">
        <label id="marbleVeinLabel">Marmor-Adern</label>
        <input id="marbleVein" type="range" min="0" max="2" step="0.01" value="0.9">
      </div>

      <div class="row">
        <label id="fabricWeaveLabel">Gewebe-Dichte</label>
        <input id="fabricWeave" type="range" min="0.5" max="6" step="0.1" value="2.4">
      </div>

      <h3 class="small" style="margin-top:30px; margin-bottom:30px">Optionen</h3>
      <div class="row">
        <label>Nahtlos Gr√∂√üe</label>
        <select id="sizeSelect">
          <option value="256">256</option>
          <option value="512" selected>512</option>
          <option value="1024">1024</option>
          <option value="2048">2048</option>
        </select>
      </div>

      <div class="row">
        <label>Vorschau Qualit√§t</label>
        <select id="previewQuality">
          <option value="256">256</option>
          <option value="512" selected>512</option>
          <option value="768">768</option>
        </select>
      </div>

     <div class="row" style="margin-top:8px; align-items:center;">
  <label>Autom. Zufall</label>
  <button id="autoRandomBtn" class="btn">Los</button>
</div>


      <div style="display:flex;gap:8px;margin-top:50px">
        <button id="saveProj" class="btn">üíæ Projekt sichern</button>
        <button id="loadProj" class="btn">üìÇ Projekt laden</button>
        <input type="file" id="projLoader" accept="application/json" style="display:none"/>
      </div>
	  <div style="display:flex;justify-content:center;gap:8px;margin-top:8px;margin-bottom:50px">
  <button id="exportBtn" class="btn">‚¨á PNG exportieren</button>
</div>
	  
          <div class="small" style="text-align:center;">Kurzbefehle: R = Zufall, E = Export</div>
    </aside>

    <main class="panel preview">
      <canvas id="previewCanvas"></canvas>
    </main>
	  
    <footer class="small panel" style="display:flex;gap:12px;align-items:center;justify-content:space-between">
      <div>Texturen-Generator von <b>Soma</b>Werk Medienproduktion - Exportierte Inhalte sind frei lizensierbar.</div>
      <div class="small">&copy; <b>Soma</b>Werk Medienproduktion</div>
    </footer>
  </div>
	
<script>
    function checkDevice() {
      if (window.innerWidth < 1024) {
        // App ausblenden
        document.querySelector('#app').style.display = 'none';
        // Warnung einblenden
        document.querySelector('.mobile-block').style.display = 'block';
      } else {
        // App sichtbar
        document.querySelector('#app').style.display = 'grid';
        // Warnung ausblenden
        document.querySelector('.mobile-block').style.display = 'none';
      }
    }

    // Bei Start und bei Fenstergr√∂√üe √§ndern pr√ºfen
    window.addEventListener('load', checkDevice);
    window.addEventListener('resize', checkDevice);
  </script>
<script>
/* Texture Lab - single file
   - Tileable 3D value-noise implementation for seamless textures
   - Multiple pattern generators: wood, concrete, marble, fabric, custom
   - Live controls and PNG export
   - Project save/load
*/

// -------------------- Utilities --------------------
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function lerp(a,b,t){ return a + (b-a)*t; }
function smoothstep(t){ return t*t*(3-2*t); }
function fade(t){ return t*t*(3-2*t); }

// convert hex to rgb
function hexToRgb(hex){
  hex = hex.replace('#','');
  if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
  const n = parseInt(hex,16);
  return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
}
function rgbToHex(r,g,b){
  const hh = (n)=>('0'+Math.round(n).toString(16)).slice(-2);
  return '#'+hh(r)+hh(g)+hh(b);
}
function clamp01(x){ return Math.max(0,Math.min(1,x)); }
function mixColor(c1,c2,t){
  return { r: lerp(c1.r,c2.r,t), g: lerp(c1.g,c2.g,t), b: lerp(c1.b,c2.b,t) };
}
function applyContrast(c, contrast){
  // c in [0,1], contrast factor >0
  return clamp01(((c-0.5)*contrast)+0.5);
}
function applySaturation(rgb, sat){
  // convert to HSL lightness, blend towards luminance
  const r=rgb.r/255, g=rgb.g/255, b=rgb.b/255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let l=(max+min)/2;
  // gray
  const gray = l;
  return {
    r: clamp01(lerp(gray, r, sat))*255,
    g: clamp01(lerp(gray, g, sat))*255,
    b: clamp01(lerp(gray, b, sat))*255
  };
}

// -------------------- Tileable Value Noise (3D) --------------------
// We'll implement value noise in 3D and sample on a torus (cos/sin mapping) to be periodic.

class TileNoise {
  constructor(seed=0){
    this.seed = seed|0;
    this.perm = new Uint32Array(512);
    this._buildPerm();
  }
  _randInt(x){
    // x -> deterministic pseudo random 32bit
    x = (x + 0x7ed55d16 + (this.seed<<6) + (this.seed>>2))|0;
    x = (x ^ (x >>> 15)) * (x | 1);
    x ^= x + ((x ^ (x >>> 7)) * (x | 61));
    return x ^ (x >>> 14);
  }
  _buildPerm(){
    // initialize permutations
    const p = new Uint32Array(256);
    for(let i=0;i<256;i++) p[i]=i;
    // fisher-yates shuffle using seed
    let seed = this.seed|0;
    for(let i=255;i>0;i--){
      seed = (seed * 1664525 + 1013904223)|0;
      const j = Math.abs(seed) % (i+1);
      const t = p[i]; p[i]=p[j]; p[j]=t;
    }
    for(let i=0;i<512;i++) this.perm[i] = p[i & 255];
  }
  // value at integer grid point
  valueAt(ix,iy,iz){
    // generate pseudo random float in [-1,1]
    const idx = (this.perm[(ix & 255)] + this.perm[(iy & 255)]) & 255;
    const h = this._randInt(idx + iz) >>> 0;
    // convert to [0,1)
    return ((h & 0xffffff)/0x1000000)*2 - 1;
  }
  // trilinear interpolation
  noise3(x,y,z){
    // x,y,z arbitrary floats
    const X = Math.floor(x), Y = Math.floor(y), Z = Math.floor(z);
    const xf = x - X, yf = y - Y, zf = z - Z;
    const u = fade(xf), v = fade(yf), w = fade(zf);
    // corners
    const c000 = this.valueAt(X, Y, Z);
    const c100 = this.valueAt(X+1, Y, Z);
    const c010 = this.valueAt(X, Y+1, Z);
    const c110 = this.valueAt(X+1, Y+1, Z);
    const c001 = this.valueAt(X, Y, Z+1);
    const c101 = this.valueAt(X+1, Y, Z+1);
    const c011 = this.valueAt(X, Y+1, Z+1);
    const c111 = this.valueAt(X+1, Y+1, Z+1);
    const x00 = lerp(c000, c100, u);
    const x10 = lerp(c010, c110, u);
    const x01 = lerp(c001, c101, u);
    const x11 = lerp(c011, c111, u);
    const y0 = lerp(x00, x10, v);
    const y1 = lerp(x01, x11, v);
    return lerp(y0, y1, w);
  }
  // fractal noise: sample in 3D making periodic by mapping 2D coords to circle
  // px,py in [0,width), we'll map to [0,1] and then to circle
  tileableNoise2(px, py, period, octaves=4, lacunarity=2, gain=0.5){
    // map to [0,1]
    const u = px/period, v = py/period;
    // map to 3D torus coordinates
    // use radius R
    const R = 10.0;
    const a = u * Math.PI * 2;
    const b = v * Math.PI * 2;
    const x = Math.cos(a) * R;
    const y = Math.sin(a) * R;
    const z = Math.cos(b) * R * 1.315 + Math.sin(b)*0.0001;
    // fractal
    let amp = 1.0, freq = 1.0, sum = 0, norm = 0;
    for(let o=0;o<octaves;o++){
      sum += this.noise3(x*freq, y*freq, z*freq) * amp;
      norm += amp;
      amp *= gain;
      freq *= lacunarity;
    }
    return sum / norm; // roughly in [-1,1]
  }
}

// -------------------- Main App --------------------
const previewCanvas = document.getElementById('previewCanvas');
const pctx = previewCanvas.getContext('2d');

const controls = {
  patternSelect: document.getElementById('patternSelect'),
  baseColor: document.getElementById('baseColor'),
  accentColor: document.getElementById('accentColor'),
  scaleRange: document.getElementById('scaleRange'),
  grainRange: document.getElementById('grainRange'),
  roughRange: document.getElementById('roughRange'),
  glossRange: document.getElementById('glossRange'),
  contrastRange: document.getElementById('contrastRange'),
  saturationRange: document.getElementById('saturationRange'),
  woodRings: document.getElementById('woodRings'),
  marbleVein: document.getElementById('marbleVein'),
  fabricWeave: document.getElementById('fabricWeave'),
  sizeSelect: document.getElementById('sizeSelect'),
  previewQuality: document.getElementById('previewQuality'),
  randBtn: document.getElementById('randBtn'),
  exportBtn: document.getElementById('exportBtn'),
  presetWood: document.getElementById('presetWood'),
  presetConcrete: document.getElementById('presetConcrete'),
  presetMarble: document.getElementById('presetMarble'),
  presetFabric: document.getElementById('presetFabric'),
  autoRandom: document.getElementById('autoRandom'),
  saveProj: document.getElementById('saveProj'),
  loadProj: document.getElementById('loadProj'),
  projLoader: document.getElementById('projLoader'),
  previewCanvas
};

let noise = new TileNoise(Math.floor(Math.random()*0x7fffffff));
let lastRender = 0;
let animReq = null;
let manualSeed = null;

function resizePreview(){
  const rect = previewCanvas.parentElement.getBoundingClientRect();
  const q = Number(controls.previewQuality.value) || 512;
  previewCanvas.width = q;
  previewCanvas.height = q;
  // scale CSS to fit container nicely
  previewCanvas.style.width = Math.min(rect.width-20, 900) + 'px';
  previewCanvas.style.height = Math.min(rect.height-20, 900) + 'px';
}
resizePreview();
window.addEventListener('resize', ()=>{ resizePreview(); scheduleRender(); });

function getConfig(){
  return {
    pattern: controls.patternSelect.value,
    baseColor: controls.baseColor.value,
    accentColor: controls.accentColor.value,
    scale: Number(controls.scaleRange.value),
    grain: Number(controls.grainRange.value),
    rough: Number(controls.roughRange.value),
    gloss: Number(controls.glossRange.value),
    contrast: Number(controls.contrastRange.value),
    saturation: Number(controls.saturationRange.value),
    woodRings: Number(controls.woodRings.value),
    marbleVein: Number(controls.marbleVein.value),
    fabricWeave: Number(controls.fabricWeave.value),
    tileSize: Number(controls.sizeSelect.value),
    previewQuality: Number(controls.previewQuality.value)
  };
}

// -------------------- Pattern Generators --------------------
function generatePixelData(config, width, height, seed){
  // create ImageData
  const id = new ImageData(width, height);
  const baseRGB = hexToRgb(config.baseColor);
  const accRGB = hexToRgb(config.accentColor);
  const tile = config.tileSize;
  // precompute some variables
  const scale = config.scale;
  const grain = config.grain;
  const rough = config.rough;
  // use noise instance seeded
  noise = new TileNoise(seed|0);

  // iterate pixels
  // we'll sample noise.tileableNoise2(x,y,period) using period = tile
  const period = tile;
  for(let y=0;y<height;y++){
    for(let x=0;x<width;x++){
      const i = (y*width + x)*4;
      // normalized coords in [0,period)
      const nx = (x / width) * period;
      const ny = (y / height) * period;

      // base fractal turbulence
      const baseNoise = noise.tileableNoise2(nx*scale, ny*scale, period, 5, 2.0, 0.5); // ~[-1,1]
      const n = baseNoise; // -1..1

      let val = 0; // intensity 0..1 produced by each pattern

      if(config.pattern === 'wood'){
        // wood rings: distance from center in tile space with turbulence
        const cx = period/2, cy = period/2;
        const dx = nx - cx, dy = ny - cy;
        const r = Math.sqrt(dx*dx + dy*dy);
        // ring frequency affected by woodRings and scale
        const rings = config.woodRings;
        const t = r * rings * 0.06 * scale + n * grain * 0.5;
        val = (Math.sin(t * Math.PI * 2) * 0.5 + 0.5);
        // add fine grain
        val = clamp01(val * (1 - rough*0.2) + (n*0.5+0.5)*rough*0.2);
      } else if(config.pattern === 'marble'){
        // marble: use sinusoidal veins with turbulence
        const angle = Math.atan2(ny - period/2, nx - period/2);
        const r = Math.sqrt((nx-period/2)**2 + (ny-period/2)**2);
        const t = r * 0.025 * scale + n * config.marbleVein * 0.9;
        val = (Math.sin(t * Math.PI * 2) * 0.5 + 0.5);
        // invert for marble look, combine with baseNoise
        val = clamp01(val*0.85 + (n*0.5+0.5)*0.25);
      } else if(config.pattern === 'concrete'){
        // concrete: base gray with speckles and pores
        const speck = Math.abs(noise.tileableNoise2(nx*scale*4, ny*scale*4, period, 3, 2, 0.6));
        val = clamp01((n*0.5+0.5) * (0.9 - rough*0.2) + speck*rough*0.6);
        // add small speckles
        const s2 = Math.abs(noise.tileableNoise2(nx*scale*60, ny*scale*60, period, 2,2,0.5));
        val = clamp01(val * 0.9 + s2 * 0.1 * rough*1.6);
      } else if(config.pattern === 'fabric'){
        // fabric weave: product of two sin patterns + noise
        const wx = Math.sin((nx/period) * Math.PI * config.fabricWeave * scale);
        const wy = Math.sin((ny/period) * Math.PI * config.fabricWeave * scale);
        val = clamp01((wx*wy*0.5 + 0.5) * (0.9 - rough*0.2) + (n*0.5+0.5)*rough*0.15);
        // add subtle cross grain
        const cross = Math.abs(noise.tileableNoise2(nx*scale*8, ny*scale*8, period, 3,2,0.5));
        val = clamp01(val*0.9 + cross*0.1*rough);
      } else { // custom noise
        val = clamp01(n*0.5 + 0.5);
      }

      // color mix: use base and accent based on value
      const mixed = mixColor(baseRGB, accRGB, val);
      // apply saturation & contrast & roughness/spec
      let rr = mixed.r/255, gg = mixed.g/255, bb = mixed.b/255;
      // specular highlight simulation (simple)
      const spec = Math.pow(clamp01(1 - Math.abs(val - 0.3)*2) , 6) * config.gloss * 0.9;
      rr = clamp01(rr + spec);
      gg = clamp01(gg + spec);
      bb = clamp01(bb + spec);
      // apply saturation
      const satApplied = applySaturation({r:rr*255,g:gg*255,b:bb*255}, config.saturation);
      // apply contrast
      const cR = applyContrast(satApplied.r/255, config.contrast);
      const cG = applyContrast(satApplied.g/255, config.contrast);
      const cB = applyContrast(satApplied.b/255, config.contrast);

      // final roughness modulation (darker pores)
      const roughnessMask = (Math.abs(noise.tileableNoise2(nx*scale*8, ny*scale*8, period, 3,2,0.5))+1)/2;
      const finalR = clamp01(cR * (1 - config.rough*0.15) * (0.85 + roughnessMask*config.rough*0.2));
      const finalG = clamp01(cG * (1 - config.rough*0.15) * (0.85 + roughnessMask*config.rough*0.2));
      const finalB = clamp01(cB * (1 - config.rough*0.15) * (0.85 + roughnessMask*config.rough*0.2));

      id.data[i+0] = Math.round(finalR * 255);
      id.data[i+1] = Math.round(finalG * 255);
      id.data[i+2] = Math.round(finalB * 255);
      id.data[i+3] = 255;
    }
  }
  return id;
}

// -------------------- Render Loop & UI --------------------
let renderScheduled = false;
let lastSeed = Math.floor(Math.random()*0xffffffff);
function scheduleRender(){
  if(renderScheduled) return;
  renderScheduled = true;
  requestAnimationFrame(()=>{ renderScheduled=false; renderPreview(); });
}

function renderPreview(){
  const cfg = getConfig();
  const q = Number(cfg.previewQuality) || 512;
  // ensure preview canvas size OK
  previewCanvas.width = q;
  previewCanvas.height = q;
  // regenerate with current seed (keep seed stable until randomize)
  const seed = lastSeed;
  // generate pixel data
  const imgData = generatePixelData(cfg, q, q, seed);
  pctx.putImageData(imgData, 0, 0);
  lastRender = performance.now();
}

// initial render
scheduleRender();

// connect controls to rendering
[
  controls.patternSelect, controls.baseColor, controls.accentColor,
  controls.scaleRange, controls.grainRange, controls.roughRange,
  controls.glossRange, controls.contrastRange, controls.saturationRange,
  controls.woodRings, controls.marbleVein, controls.fabricWeave,
  controls.previewQuality
].forEach(el => {
  el.addEventListener('input', ()=>{ scheduleRender(); });
  el.addEventListener('change', ()=>{ scheduleRender(); });
});

// Randomize function
function randomizePreset(){
  const patterns = ['wood','concrete','marble','fabric','customNoise'];
  const p = patterns[Math.floor(Math.random()*patterns.length)];
  controls.patternSelect.value = p;
  // random colors tunable
  const base = Math.floor(Math.random()*360);
  function hslToHex(h,s,l){
    // basic hsl to hex
    const a = s * Math.min(l,1-l) / 100;
    const f = (n) => {
      const k = (n + h/30) % 12;
      const color = l/100 - a * Math.max(Math.min(k-3,9-k,1), -1);
      return Math.round(255*color);
    };
    return rgbToHex(f(0), f(8), f(4));
  }
  const hue = Math.floor(Math.random()*360);
  controls.baseColor.value = hslToHex(hue, 35 + Math.random()*60, 35 + Math.random()*30);
  controls.accentColor.value = hslToHex((hue+30+Math.random()*120)%360, 40 + Math.random()*50, 18 + Math.random()*40);
  controls.scaleRange.value = (0.5 + Math.random()*4).toFixed(2);
  controls.grainRange.value = (Math.random()*0.9 + 0.05).toFixed(2);
  controls.roughRange.value = (Math.random()*1.2 + 0.05).toFixed(2);
  controls.glossRange.value = (Math.random()*0.6).toFixed(2);
  controls.contrastRange.value = (0.8 + Math.random()*1.4).toFixed(2);
  controls.saturationRange.value = (0.6 + Math.random()*1.4).toFixed(2);
  controls.woodRings.value = (1 + Math.random()*4).toFixed(2);
  controls.marbleVein.value = (0.2 + Math.random()*1.8).toFixed(2);
  controls.fabricWeave.value = (1 + Math.random()*4).toFixed(2);

  lastSeed = Math.floor(Math.random()*0xffffffff);
  scheduleRender();
}
controls.randBtn.addEventListener('click', randomizePreset);

// presets
controls.presetWood.addEventListener('click', ()=>{
  controls.patternSelect.value='wood';
  controls.baseColor.value='#a77a4f';
  controls.accentColor.value='#3b2b22';
  controls.scaleRange.value='0.4';
  controls.grainRange.value='0.5';
  controls.roughRange.value='0.9';
  controls.glossRange.value='0.08';
  controls.woodRings.value='2.4';
  lastSeed = Math.floor(Math.random()*0xffffffff);
  scheduleRender();
});
controls.presetConcrete.addEventListener('click', ()=>{
  controls.patternSelect.value='concrete';
  controls.baseColor.value='#9ea3a6';
  controls.accentColor.value='#6d6f70';
  controls.scaleRange.value='2.8';
  controls.grainRange.value='0.9';
  controls.roughRange.value='1.3';
  controls.glossRange.value='0.02';
  lastSeed = Math.floor(Math.random()*0xffffffff);
  scheduleRender();
});
controls.presetMarble.addEventListener('click', ()=>{
  controls.patternSelect.value='marble';
  controls.baseColor.value='#efe9e5';
  controls.accentColor.value='#bfb8b2';
  controls.scaleRange.value='0.3';
  controls.grainRange.value='0.3';
  controls.roughRange.value='0.2';
  controls.glossRange.value='0.25';
  controls.marbleVein.value='1.0';
  lastSeed = Math.floor(Math.random()*0xffffffff);
  scheduleRender();
});
controls.presetFabric.addEventListener('click', ()=>{
  controls.patternSelect.value='fabric';
  controls.baseColor.value='#00FFFF';
  controls.accentColor.value='#00cf35';
  controls.scaleRange.value='0.5';
  controls.grainRange.value='0.35';
  controls.roughRange.value='0.0';
  controls.glossRange.value='0.06';
  controls.fabricWeave.value='2.6';
  lastSeed = Math.floor(Math.random()*0xffffffff);
  scheduleRender();
});

// auto random toggle
let autoRandomTimer = null;
const autoBtn = document.getElementById('autoRandomBtn');

autoBtn.addEventListener('click', () => {
  if(autoRandomTimer === null){
    // Start Automatik
    autoRandomTimer = setInterval(()=>{ randomizePreset(); }, 1500);
    autoBtn.textContent = "Stopp";
  } else {
    // Stop Automatik
    clearInterval(autoRandomTimer);
    autoRandomTimer = null;
    autoBtn.textContent = "Los";
  }
});


// export full-size PNG
controls.exportBtn.addEventListener('click', ()=>{
  exportPNG(Number(controls.sizeSelect.value) || 512);
});
function exportPNG(size){
  const cfg = getConfig();
  const exportSize = size;
  // create canvas
  const tmp = document.createElement('canvas');
  tmp.width = exportSize;
  tmp.height = exportSize;
  const tctx = tmp.getContext('2d');
  // regenerate with same seed for consistency
  const imgData = generatePixelData(cfg, exportSize, exportSize, lastSeed);
  tctx.putImageData(imgData, 0, 0);
  // trigger download
  tmp.toBlob((blob)=>{
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `texture_${cfg.pattern}_${exportSize}px.png`;
    a.click();
    URL.revokeObjectURL(url);
  }, 'image/png');
}

// keyboard shortcuts
window.addEventListener('keydown', (e)=>{
  if(e.key === 'r' || e.key === 'R'){ randomizePreset(); }
  if(e.key === 'e' || e.key === 'E'){ exportPNG(Number(controls.sizeSelect.value)); }
});

// Save/load project
controls.saveProj.addEventListener('click', ()=>{
  const cfg = getConfig();
  const proj = { cfg, seed: lastSeed, created: (new Date()).toISOString() };
  const blob = new Blob([JSON.stringify(proj)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'texturelab_project.json'; a.click();
  URL.revokeObjectURL(url);
});
controls.loadProj.addEventListener('click', ()=> controls.projLoader.click());
controls.projLoader.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try{
      const obj = JSON.parse(ev.target.result);
      if(obj && obj.cfg){
        // apply config
        const c = obj.cfg;
        controls.patternSelect.value = c.pattern || controls.patternSelect.value;
        controls.baseColor.value = c.baseColor || controls.baseColor.value;
        controls.accentColor.value = c.accentColor || controls.accentColor.value;
        controls.scaleRange.value = c.scale || controls.scaleRange.value;
        controls.grainRange.value = c.grain || controls.grainRange.value;
        controls.roughRange.value = c.rough || controls.roughRange.value;
        controls.glossRange.value = c.gloss || controls.glossRange.value;
        controls.contrastRange.value = c.contrast || controls.contrastRange.value;
        controls.saturationRange.value = c.saturation || controls.saturationRange.value;
        controls.woodRings.value = c.woodRings || controls.woodRings.value;
        controls.marbleVein.value = c.marbleVein || controls.marbleVein.value;
        controls.fabricWeave.value = c.fabricWeave || controls.fabricWeave.value;
        lastSeed = obj.seed || Math.floor(Math.random()*0xffffffff);
        scheduleRender();
      } else {
        alert('Ung√ºltiges Projekt');
      }
    }catch(err){ alert('Fehler beim Laden'); }
  };
  reader.readAsText(f);
  e.target.value = '';
});

// initial random
randomizePreset();
scheduleRender();

</script>
</body>
</html>









